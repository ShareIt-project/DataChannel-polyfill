/*! datachannel.min.js build:1.0.0-3, production. Copyright(c) 2013 Jesús Leganés Combarro "Piranna" <piranna@gmail.com> */(function(e){function n(e){function a(e,n){var r=this;t.call(this),this.close=function(){this._udt&&this._udt.close()},this.send=function(e){this._udt&&this._udt.send(e)},this.__defineGetter__("binaryType",function(){return r._udt.binaryType}),this.__defineSetter__("binaryType",function(e){r._udt.binaryType=e}),this.__defineGetter__("bufferedAmount",function(){return r._udt?r._udt.bufferedAmount:0}),this.__defineGetter__("label",function(){return e}),this.__defineGetter__("readyState",function(){if(!r._udt)return"connecting";switch(r._udt.readyState){case 0:return"connecting";case 1:return"open";case 2:return"closing";case 3:return"closed"}});var i=n.id!=undefined?n.id:0;this.__defineGetter__("id",function(){return i});var s=n.maxRetransmitTime!=undefined?n.maxRetransmitTime:null;this.__defineGetter__("maxRetransmitTime",function(){return s});var o=n.maxRetransmits!=undefined?n.maxRetransmits:null;this.__defineGetter__("maxRetransmits",function(){return o});if(s&&o)throw SyntaxError;var u=!s&&!o,a=n.negotiated!=undefined?n.negotiated:!1;this.__defineGetter__("negotiated",function(){return a});var f=n.ordered!=undefined?n.ordered:!1;this.__defineGetter__("ordered",function(){return f});var l=n.protocol!=undefined?n.protocol:"";this.__defineGetter__("protocol",function(){return l})}function f(t,n,r){t._channels=t._channels||{},t._channels[n.label]=n;if(!t._peerId){console.warn("No peer ID");return}console.info("Creating UDT"),n._udt=new WebSocket(e),n._udt.addEventListener("close",function(e){n.dispatchEvent(e)}),n._udt.addEventListener("error",function(e){n.dispatchEvent(e)}),n._udt.addEventListener("open",function(e){r(n,t)})}function c(e,t,n,r){e.readyState&&(e.signalingState=e.readyState);if(e.signalingState=="closed")return;var i=new a(n,r);f(e,i,function(e){e.send(JSON.stringify(["ready",t])),e._udt.onmessage=function(t){e.dispatchEvent(t)};var n=document.createEvent("Event");n.initEvent("open",!0,!0),e.dispatchEvent(n)});var s=document.createEvent("Event");s.initEvent("datachannel",!0,!0),s.channel=i,e.dispatchEvent(s)}function h(e,t){e._udt.onmessage=function(n){var i=JSON.parse(n.data),s=i[0];switch(s){case"create.native":t._signaling&&t._signaling.close(),t.createDataChannel=r,e._udt=t.createDataChannel(e.label,e.reliable);break;case"ready":t.readyState&&(t.signalingState=t.readyState);if(self.signalingState=="closed")return;e._udt.onmessage=function(t){e.dispatchEvent(t)};var o=document.createEvent("Event");o.initEvent("open",!0,!0),e.dispatchEvent(o);break;default:console.error("Unknown event '"+s+"'")}},e.send(JSON.stringify(["create",t._peerId,e.label,e.reliable,Boolean(r)]))}function p(e){var t=/^o=.+/gm,n=t.exec(e.sdp);return n[0].substring(2)}var n=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection;if(n==undefined)return console.error("Your browser doesn't support RTCPeerConnection, please use one of the latest versions of Chrome/Chromium or Firefox"),"old browser";var r,i=!1,s="stun:stun.l.google.com:19302",o=new n({iceServers:[{url:s}]},{optional:[{RtpDataChannels:!0}]});try{o.createDataChannel("DCPF_install__checkSupport",{reliable:!1}).close(),r=o.createDataChannel,o.createDataChannel("DCPF_install__checkSupport").close(),i=!0}catch(u){}finally{o.close()}if(r&&!i&&Reliable){n.prototype.createDataChannel=function(e,t){t=t||{},t.reliable=!1;var n=new Reliable(r.call(this,e,t));return n.label=e,n};var l=n.prototype.dispatchEvent;n.prototype.dispatchEvent=function(e){if(type=="datachannel"&&!(e.channel instanceof Reliable)){var t=e.channel;e.channel=new Reliable(t),e.channel.label=t.label}l.call(this,e)}}else n.prototype.createDataChannel=function(e,t){this.readyState&&(this.signalingState=this.readyState);if(this.signalingState=="closed")throw INVALID_STATE;if(!e)throw"'label' is not defined";t=t||{};var n=new a(e,t);return f(this,n,h),n};var d=n.prototype.setLocalDescription,v=n.prototype.setRemoteDescription,m=n.prototype.close;n.prototype.close=function(){this._signaling&&this._signaling.close(),m.call(this)},r||(n.prototype.setLocalDescription=function(t,n,i){var s=this;this._signaling&&this._signaling.close(),this._signaling=new WebSocket(e),this._signaling.onopen=function(e){this.onmessage=function(e){var t=JSON.parse(e.data);switch(t[0]){case"create":c(s,t[1],t[2],{reliable:t[3]});break;case"create.native":s.createDataChannel=r}},this.send(JSON.stringify(["setId","pc."+p(t),Boolean(r)]))},this._signaling.onerror=function(e){console.error(e)},d.call(this,t,n,i)}),r||(n.prototype.setRemoteDescription=function(e,t,n){this._peerId="pc."+p(e);for(var r in this._channels){var i=this._channels[r];i._udt==undefined&&f(this,i,h)}v.call(this,e,t,n)});if(r&&!i&&Reliable){var g=n.prototype.createOffer,y=n.prototype.createAnswer;n.prototype.createOffer=function(e,t,n){g.call(this,function(t){t.sdp=Reliable.higherBandwidthSDP(t.sdp),e(t)},t,n)},n.prototype.createAnswer=function(e,t,n){y.call(this,function(t){t.sdp=Reliable.higherBandwidthSDP(t.sdp),e(t)},t,n)}}return r?i?(console.log("Both native and polyfill WebRTC DataChannel are available"),"native"):(Reliable?console.warn("Native WebRTC DataChannel is not reliable, using polyfill instead"):console.error("Native WebRTC DataChannel is not reliable and not included polyfill"),"native no reliable"):(console.warn("WebRTC DataChannel is only available thought polyfill"),"polyfill")}var t=function(){var e={};this.addEventListener=function(t,n){e[t]===undefined&&(e[t]=[]),e[t].indexOf(n)===-1&&e[t].push(n)},this.dispatchEvent=function(t){var n=e[t.type]||[],r=this["on"+t.type];typeof r=="function"&&(n=n.concat(r));for(var i=0,s=n.length;i<s;i++)n[i].call(this,t)},this.removeEventListener=function(t,n){var r=e[t].indexOf(n);r!==-1&&e[t].splice(r,1)}};e.EventTarget=t,function(e){function t(){this._pieces=[],this._parts=[]}function n(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function r(e){this.utf8=e,this.bufferBuilder=new t}function i(e,t){if(!(this instanceof i))return new i(e);this._dc=e,o.debug=t,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=10,this._count=0,this._queue=[],this._setupDC()}var s={};s.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),s.useArrayBufferView=!s.useBlobBuilder&&function(){try{return(new Blob([new Uint8Array([])])).size===0}catch(e){return!0}}(),e.binaryFeatures=s,e.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder,t.prototype.append=function(e){typeof e=="number"?this._pieces.push(e):(this._flush(),this._parts.push(e))},t.prototype._flush=function(){if(this._pieces.length>0){var e=new Uint8Array(this._pieces);s.useArrayBufferView||(e=e.buffer),this._parts.push(e),this._pieces=[]}},t.prototype.getBuffer=function(){this._flush();if(s.useBlobBuilder){var e=new BlobBuilder;for(var t=0,n=this._parts.length;t<n;t++)e.append(this._parts[t]);return e.getBlob()}return new Blob(this._parts)},e.BinaryPack={unpack:function(e){var t=new n(e);return t.unpack()},pack:function(e,t){var n=new r(t),i=n.pack(e);return i}},n.prototype.unpack=function(){var e=this.unpack_uint8();if(e<128){var t=e;return t}if((e^224)<32){var n=(e^224)-32;return n}var r;if((r=e^160)<=15)return this.unpack_raw(r);if((r=e^176)<=15)return this.unpack_string(r);if((r=e^144)<=15)return this.unpack_array(r);if((r=e^128)<=15)return this.unpack_map(r);switch(e){case 192:return null;case 193:return undefined;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return undefined;case 213:return undefined;case 214:return undefined;case 215:return undefined;case 216:return r=this.unpack_uint16(),this.unpack_string(r);case 217:return r=this.unpack_uint32(),this.unpack_string(r);case 218:return r=this.unpack_uint16(),this.unpack_raw(r);case 219:return r=this.unpack_uint32(),this.unpack_raw(r);case 220:return r=this.unpack_uint16(),this.unpack_array(r);case 221:return r=this.unpack_uint32(),this.unpack_array(r);case 222:return r=this.unpack_uint16(),this.unpack_map(r);case 223:return r=this.unpack_uint32(),this.unpack_map(r)}},n.prototype.unpack_uint8=function(){var e=this.dataView[this.index]&255;return this.index++,e},n.prototype.unpack_uint16=function(){var e=this.read(2),t=(e[0]&255)*256+(e[1]&255);return this.index+=2,t},n.prototype.unpack_uint32=function(){var e=this.read(4),t=((e[0]*256+e[1])*256+e[2])*256+e[3];return this.index+=4,t},n.prototype.unpack_uint64=function(){var e=this.read(8),t=((((((e[0]*256+e[1])*256+e[2])*256+e[3])*256+e[4])*256+e[5])*256+e[6])*256+e[7];return this.index+=8,t},n.prototype.unpack_int8=function(){var e=this.unpack_uint8();return e<128?e:e-256},n.prototype.unpack_int16=function(){var e=this.unpack_uint16();return e<32768?e:e-65536},n.prototype.unpack_int32=function(){var e=this.unpack_uint32();return e<Math.pow(2,31)?e:e-Math.pow(2,32)},n.prototype.unpack_int64=function(){var e=this.unpack_uint64();return e<Math.pow(2,63)?e:e-Math.pow(2,64)},n.prototype.unpack_raw=function(e){if(this.length<this.index+e)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+e+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t},n.prototype.unpack_string=function(e){var t=this.read(e),n=0,r="",i,s;while(n<e)i=t[n],i<128?(r+=String.fromCharCode(i),n++):(i^192)<32?(s=(i^192)<<6|t[n+1]&63,r+=String.fromCharCode(s),n+=2):(s=(i&15)<<12|(t[n+1]&63)<<6|t[n+2]&63,r+=String.fromCharCode(s),n+=3);return this.index+=e,r},n.prototype.unpack_array=function(e){var t=new Array(e);for(var n=0;n<e;n++)t[n]=this.unpack();return t},n.prototype.unpack_map=function(e){var t={};for(var n=0;n<e;n++){var r=this.unpack(),i=this.unpack();t[r]=i}return t},n.prototype.unpack_float=function(){var e=this.unpack_uint32(),t=e>>31,n=(e>>23&255)-127,r=e&8388607|8388608;return(t==0?1:-1)*r*Math.pow(2,n-23)},n.prototype.unpack_double=function(){var e=this.unpack_uint32(),t=this.unpack_uint32(),n=e>>31,r=(e>>20&2047)-1023,i=e&1048575|1048576,s=i*Math.pow(2,r-20)+t*Math.pow(2,r-52);return(n==0?1:-1)*s},n.prototype.read=function(e){var t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")},r.prototype.pack=function(e){var t=typeof e;if(t=="string")this.pack_string(e);else if(t=="number")Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if(t=="boolean")e===!0?this.bufferBuilder.append(195):e===!1&&this.bufferBuilder.append(194);else if(t=="undefined")this.bufferBuilder.append(192);else{if(t!="object")throw new Error('Type "'+t+'" not yet supported');if(e===null)this.bufferBuilder.append(192);else{var n=e.constructor;if(n==Array)this.pack_array(e);else if(n==Blob||n==File)this.pack_bin(e);else if(n==ArrayBuffer)s.useArrayBufferView?this.pack_bin(new Uint8Array(e)):this.pack_bin(e);else if("BYTES_PER_ELEMENT"in e)s.useArrayBufferView?this.pack_bin(e):this.pack_bin(e.buffer);else if(n==Object)this.pack_object(e);else if(n==Date)this.pack_string(e.toString());else{if(typeof e.toBinaryPack!="function")throw new Error('Type "'+n.toString()+'" not yet supported');this.bufferBuilder.append(e.toBinaryPack())}}}return this.bufferBuilder.getBuffer()},r.prototype.pack_bin=function(e){var t=e.length||e.byteLength||e.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(t)}this.bufferBuilder.append(e)},r.prototype.pack_string=function(e){var t;if(this.utf8){var n=new Blob([e]);t=n.size}else t=e.length;if(t<=15)this.pack_uint8(176+t);else if(t<=65535)this.bufferBuilder.append(216),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(t)}this.bufferBuilder.append(e)},r.prototype.pack_array=function(e){var t=e.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(t)}for(var n=0;n<t;n++)this.pack(e[n])},r.prototype.pack_integer=function(e){if(-32<=e&&e<=127)this.bufferBuilder.append(e&255);else if(0<=e&&e<=255)this.bufferBuilder.append(204),this.pack_uint8(e);else if(-128<=e&&e<=127)this.bufferBuilder.append(208),this.pack_int8(e);else if(0<=e&&e<=65535)this.bufferBuilder.append(205),this.pack_uint16(e);else if(-32768<=e&&e<=32767)this.bufferBuilder.append(209),this.pack_int16(e);else if(0<=e&&e<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(e);else if(-2147483648<=e&&e<=2147483647)this.bufferBuilder.append(210),this.pack_int32(e);else if(-0x8000000000000000<=e&&e<=0x8000000000000000)this.bufferBuilder.append(211),this.pack_int64(e);else{if(!(0<=e&&e<=0x10000000000000000))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(e)}},r.prototype.pack_double=function(e){var t=0;e<0&&(t=1,e=-e);var n=Math.floor(Math.log(e)/Math.LN2),r=e/Math.pow(2,n)-1,i=Math.floor(r*Math.pow(2,52)),s=Math.pow(2,32),o=t<<31|n+1023<<20|i/s&1048575,u=i%s;this.bufferBuilder.append(203),this.pack_int32(o),this.pack_int32(u)},r.prototype.pack_object=function(e){var t=Object.keys(e),n=t.length;if(n<=15)this.pack_uint8(128+n);else if(n<=65535)this.bufferBuilder.append(222),this.pack_uint16(n);else{if(!(n<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(n)}for(var r in e)e.hasOwnProperty(r)&&(this.pack(r),this.pack(e[r]))},r.prototype.pack_uint8=function(e){this.bufferBuilder.append(e)},r.prototype.pack_uint16=function(e){this.bufferBuilder.append(e>>8),this.bufferBuilder.append(e&255)},r.prototype.pack_uint32=function(e){var t=e&4294967295;this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255)},r.prototype.pack_uint64=function(e){var t=e/Math.pow(2,32),n=e%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((n&4278190080)>>>24),this.bufferBuilder.append((n&16711680)>>>16),this.bufferBuilder.append((n&65280)>>>8),this.bufferBuilder.append(n&255)},r.prototype.pack_int8=function(e){this.bufferBuilder.append(e&255)},r.prototype.pack_int16=function(e){this.bufferBuilder.append((e&65280)>>8),this.bufferBuilder.append(e&255)},r.prototype.pack_int32=function(e){this.bufferBuilder.append(e>>>24&255),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)},r.prototype.pack_int64=function(e){var t=Math.floor(e/Math.pow(2,32)),n=e%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((n&4278190080)>>>24),this.bufferBuilder.append((n&16711680)>>>16),this.bufferBuilder.append((n&65280)>>>8),this.bufferBuilder.append(n&255)};var o={debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:BinaryPack.pack,unpack:BinaryPack.unpack,log:function(){if(o.debug){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];e.unshift("Reliable: "),console.log.apply(console,e)}},setZeroTimeout:function(e){function t(t){r.push(t),e.postMessage(i,"*")}function n(t){t.source==e&&t.data==i&&(t.stopPropagation&&t.stopPropagation(),r.length&&r.shift()())}var r=[],i="zero-timeout-message";return e.addEventListener?e.addEventListener("message",n,!0):e.attachEvent&&e.attachEvent("onmessage",n),t}(this),blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){var t=new Uint8Array(e.length);for(var n=0;n<e.length;n++)t[n]=e.charCodeAt(n)&255;return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)}};i.prototype.send=function(e){var t=o.pack(e);if(t.size<this._mtu){this._handleSend(["no",t]);return}this._outgoing[this._count]={ack:0,chunks:this._chunk(t)},o.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),this._count+=1},i.prototype.onmessage=function(e){},i.prototype._setupInterval=function(){var e=this;this._timeout=setInterval(function(){var t=e._queue.shift();if(t._multiple)for(var n=0,r=t.length;n<r;n+=1)e._intervalSend(t[n]);else e._intervalSend(t)},this._interval)},i.prototype._intervalSend=function(e){var t=this;o.log("Sending...",e),e=o.pack(e),o.blobToBinaryString(e,function(e){t._dc.send(e)}),t._queue.length===0&&(clearTimeout(t._timeout),t._timeout=null,t._processAcks())},i.prototype._processAcks=function(){for(var e in this._outgoing)this._outgoing.hasOwnProperty(e)&&this._sendWindowedChunks(e)},i.prototype._handleSend=function(e){var t=!0;for(var n=0,r=this._queue.length;n<r;n+=1){var i=this._queue[n];i===e?t=!1:i._multiple&&i.indexOf(e)!==-1&&(t=!1)}t&&(this._queue.push(e),this._timeout||this._setupInterval())},i.prototype._setupDC=function(){var e=this;this._dc.onmessage=function(t){var n=t.data,r=n.constructor;if(r===String){var i=o.binaryStringToArrayBuffer(n);n=o.unpack(i),e._handleMessage(n)}}},i.prototype._handleMessage=function(e){o.log("handleMessage: ",e);var t=e[1],n=this._incoming[t],r=this._outgoing[t],i;switch(e[0]){case"no":var s=t;!s||this.onmessage({data:o.unpack(s)});break;case"end":i=n,!i||i.ack[2]!==e[2]?!i||this._ack(t,i.ack):(this._complete(t),this._received[t]=!0);break;case"ack":i=r;if(!!i){var u=e[2];i.ack=Math.max(u,i.ack),i.ack>=i.chunks.length?(o.log("Time: ",new Date-i.timer),delete this._outgoing[t]):this._processAcks()}break;case"chunk":i=n;if(!i){if(this._received[t]!==undefined)break;i={ack:["ack",t,0],chunks:[]},this._incoming[t]=i}var a=e[2],f=e[3];i.chunks[a]=new Uint8Array(f),a===i.ack[2]&&this._calculateNextAck(t),this._ack(t);break;default:this._handleSend(e)}},i.prototype._chunk=function(e){var t=[],n=e.size,r=0;while(r<n){var i=Math.min(n,r+this._mtu),s=e.slice(r,i),o={payload:s};t.push(o),r=i}return t},i.prototype._ack=function(e,t){var n=this._incoming[e].ack;this._handleSend(n)},i.prototype._calculateNextAck=function(e){var t=this._incoming[e],n=t.chunks;for(var r=0,i=n.length;r<i;r+=1)if(n[r]===undefined){t.ack[2]=r;return}t.ack[2]=n.length},i.prototype._sendWindowedChunks=function(e){o.log("sendWindowedChunks for: ",e);var t=this._outgoing[e],n=t.chunks,r=[],i=Math.min(t.ack+this._window,n.length);for(var s=t.ack;s<i;s+=1)if(!n[s].sent||s===t.ack)s===t.ack&&n[s].sent?(this._window=Math.max(1,Math.round(this._window/10)),i=Math.min(t.ack+this._window,n.length)):s===t.ack&&(this._window=Math.min(1e3,Math.round(this._window*10)),i=Math.min(t.ack+this._window,n.length)),n[s].sent=!0,r.push(["chunk",e,s,n[s].payload]);t.ack+this._window>=n.length-1&&r.push(["end",e,n.length]),r._multiple=!0,this._handleSend(r)},i.prototype._complete=function(e){o.log("Complete",e);var t=this,n=this._incoming[e].chunks,r=new Blob(n);o.blobToArrayBuffer(r,function(e){o.log("Calling onmessage with complete message"),t.onmessage({data:o.unpack(e)})}),delete this._incoming[e]},i.higherBandwidthSDP=function(e){var t=e.split("b=AS:30"),n="b=AS:102400";return t[0]+n+t[1]},e.Reliable=i}(this),e.DCPF_install=n})(this)